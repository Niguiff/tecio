{% extends "base.html" %}

{% block content %}
<div class="row fade-in">
    <div class="col-md-8">
        
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">1Ô∏è‚É£ Paso 1: Elige el Producto</h5>
            </div>
            <div class="card-body">
                <div class="row" id="contenedor-productos">
                    {% for p in productos %}
                    <div class="col-md-3 col-6 mb-2">
                        <button class="btn btn-outline-primary w-100 py-3 btn-producto" 
                                data-nombre="{{ p.nombre }}" 
                                data-precio="{{ p.precio }}"
                                data-helado="{{ 'si' if p.es_helado else 'no' }}">
                            <strong>{{ p.nombre }}</strong><br>
                            <small>${{ p.precio }}</small>
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="card shadow-sm" id="card-sabores" style="display:none;">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">2Ô∏è‚É£ Paso 2: Elige Sabores (Opcional)</h5>
                <small>M√°ximo: <span id="max-gustos">4</span></small>
            </div>
            <div class="card-body p-2">
                <input type="text" id="buscador-sabores" class="form-control mb-3" placeholder="üîç Buscar gusto...">
                
                <div class="row g-2" id="contenedor-sabores" style="max-height: 400px; overflow-y: auto;">
                    {% for s in sabores %}
                    <div class="col-md-3 col-4">
                        <button class="btn btn-outline-dark w-100 text-truncate btn-sabor" 
                                data-nombre="{{ s.nombre }}"
                                style="font-size: 0.9rem;">
                            {{ s.nombre }}
                        </button>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-3 text-end">
                    <button class="btn btn-success btn-lg" id="btn-confirmar-item">
                        ‚úÖ Confirmar (<span id="contador-gustos">0</span>)
                    </button>
                </div>
            </div>
        </div>

    </div>

    <div class="col-md-4">
        <div class="card shadow-sm border-primary">
            <div class="card-header bg-primary text-white text-center">
                <h4 class="mb-0">üõí Tu Pedido</h4>
            </div>
            <div class="card-body p-0">
                <ul id="lista-carrito" class="list-group list-group-flush" style="min-height: 300px; max-height: 500px; overflow-y: auto;">
                    </ul>
            </div>
            <div class="card-footer bg-light">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Total:</h3>
                    <h2 class="text-primary fw-bold">$<span id="total-carrito">0</span></h2>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-success btn-lg py-3" onclick="finalizarVenta('Efectivo')">
                        üíµ COBRAR EFECTIVO
                    </button>
                    <div class="row g-1">
                        <div class="col-6">
                            <button class="btn btn-info w-100 text-white" onclick="finalizarVenta('MercadoPago')">
                                üì± QR / MP
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-warning w-100 text-white" onclick="finalizarVenta('Tarjeta')">
                                üí≥ TARJETA
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let carrito = [];
    let productoSeleccionado = null;
    let gustosSeleccionados = [];
    const MAX_GUSTOS = 4; // Puedes ajustar esto o hacerlo din√°mico seg√∫n el tama√±o

    // --- 1. SELECCIONAR PRODUCTO ---
    document.querySelectorAll('.btn-producto').forEach(btn => {
        btn.addEventListener('click', function() {
            // Reset visual
            document.querySelectorAll('.btn-producto').forEach(b => b.classList.remove('active', 'btn-primary'));
            document.querySelectorAll('.btn-producto').forEach(b => b.classList.add('btn-outline-primary'));
            
            // Activar bot√≥n
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-primary', 'active');

            productoSeleccionado = {
                nombre: this.dataset.nombre,
                precio: parseFloat(this.dataset.precio),
                esHelado: this.dataset.helado === 'si'
            };

            // Reset gustos
            gustosSeleccionados = [];
            actualizarVisualGustos();

            if (productoSeleccionado.esHelado) {
                document.getElementById('card-sabores').style.display = 'block';
                // Scroll autom√°tico hacia sabores
                document.getElementById('card-sabores').scrollIntoView({behavior: 'smooth'});
            } else {
                // Si no es helado (ej: gaseosa), se agrega directo
                document.getElementById('card-sabores').style.display = 'none';
                agregarAlCarrito();
            }
        });
    });

    // --- 2. SELECCIONAR SABORES ---
    document.querySelectorAll('.btn-sabor').forEach(btn => {
        btn.addEventListener('click', function() {
            const nombreSabor = this.dataset.nombre;

            if (gustosSeleccionados.includes(nombreSabor)) {
                // Deseleccionar
                gustosSeleccionados = gustosSeleccionados.filter(g => g !== nombreSabor);
                this.classList.remove('btn-dark');
                this.classList.add('btn-outline-dark');
            } else {
                // Seleccionar (si no pas√≥ el l√≠mite)
                if (gustosSeleccionados.length < MAX_GUSTOS) {
                    gustosSeleccionados.push(nombreSabor);
                    this.classList.remove('btn-outline-dark');
                    this.classList.add('btn-dark');
                }
            }
            actualizarContadorGustos();
        });
    });

    // Buscador de Sabores (Filtro en tiempo real)
    document.getElementById('buscador-sabores').addEventListener('keyup', function() {
        const busqueda = this.value.toLowerCase();
        document.querySelectorAll('.btn-sabor').forEach(btn => {
            const texto = btn.innerText.toLowerCase();
            if (texto.includes(busqueda)) {
                btn.parentElement.style.display = 'block';
            } else {
                btn.parentElement.style.display = 'none';
            }
        });
    });

    // Bot√≥n Confirmar Gustos
    document.getElementById('btn-confirmar-item').addEventListener('click', function() {
        if (!productoSeleccionado) return;
        agregarAlCarrito();
        
        // Resetear selecci√≥n para el pr√≥ximo item
        document.getElementById('card-sabores').style.display = 'none';
        document.querySelectorAll('.btn-producto').forEach(b => b.classList.remove('active', 'btn-primary'));
        document.querySelectorAll('.btn-producto').forEach(b => b.classList.add('btn-outline-primary'));
        document.querySelectorAll('.btn-sabor').forEach(b => {
            b.classList.remove('btn-dark');
            b.classList.add('btn-outline-dark');
        });
        gustosSeleccionados = [];
        productoSeleccionado = null;
        actualizarContadorGustos();
        
        // Scroll arriba
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    function actualizarContadorGustos() {
        document.getElementById('contador-gustos').innerText = gustosSeleccionados.length;
    }

    function actualizarVisualGustos() {
        document.querySelectorAll('.btn-sabor').forEach(b => {
            b.classList.remove('btn-dark');
            b.classList.add('btn-outline-dark');
        });
        actualizarContadorGustos();
    }

    // --- 3. CARRITO ---
    function agregarAlCarrito() {
        // Clonamos los gustos para que no se borren por referencia
        let item = {
            formato: productoSeleccionado.nombre,
            precio: productoSeleccionado.precio,
            sabores: [...gustosSeleccionados] 
        };
        carrito.push(item);
        renderizarCarrito();
    }

    function renderizarCarrito() {
        const lista = document.getElementById('lista-carrito');
        const totalSpan = document.getElementById('total-carrito');
        lista.innerHTML = '';
        let total = 0;

        carrito.forEach((item, index) => {
            total += item.precio;
            
            let htmlSabores = '';
            if (item.sabores.length > 0) {
                htmlSabores = `<small class="text-muted d-block" style="font-size:0.8em">(${item.sabores.join(', ')})</small>`;
            } else if (productoSeleccionado && productoSeleccionado.esHelado) {
                // Opcional: Mostrar que va vac√≠o si era helado
                // htmlSabores = '<small class="text-danger d-block" style="font-size:0.8em">(Sin gustos seleccionados)</small>';
            }

            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <div>
                    <h6 class="my-0">${item.formato}</h6>
                    ${htmlSabores}
                </div>
                <div class="d-flex align-items-center">
                    <span class="fw-bold me-3">$${item.precio}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarDelCarrito(${index})">X</button>
                </div>
            `;
            lista.appendChild(li);
        });

        totalSpan.innerText = total.toLocaleString();
    }

    function eliminarDelCarrito(index) {
        carrito.splice(index, 1);
        renderizarCarrito();
    }

    // --- 4. ENVIAR AL SERVIDOR (COBRAR) ---
    function finalizarVenta(medioPago) {
        if (carrito.length === 0) {
            alert('El carrito est√° vac√≠o');
            return;
        }

        if (!confirm(`¬øConfirmar venta por $${document.getElementById('total-carrito').innerText} en ${medioPago}?`)) {
            return;
        }

        // Enviar datos a Flask con Fetch API
        fetch('/vender', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                items: carrito,
                medio_pago: medioPago
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // √âxito
                carrito = [];
                renderizarCarrito();
                alert('‚úÖ Venta registrada correctamente!');
                // Opcional: Recargar p√°gina para limpiar todo visualmente
                // location.reload();
            } else {
                alert('‚ùå Error: ' + data.msg);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexi√≥n.');
        });
    }
</script>
{% endblock %}